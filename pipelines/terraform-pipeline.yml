# pipelines/basic-terraform-pipeline.yml
trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - terraform/*
    - pipelines/*

variables:
  terraformVersion: 'latest'
  azureServiceConnection: 'azure-terraform-service-connection'
  terraformWorkingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: TerraformValidation
  displayName: 'Terraform Validation'
  jobs:
  - job: Validate
    displayName: 'Validate Terraform Configuration'
    steps:

    # Install Terraform
    - task: TerraformInstaller@1
      displayName: 'Install Terraform $(terraformVersion)'
      inputs:
        terraformVersion: $(terraformVersion)

    # Terraform Init
    - task: TerraformCLI@1
      displayName: 'Terraform Init'
      inputs:
        command: 'init'
        workingDirectory: $(terraformWorkingDirectory)
        backendType: azurerm
        backendServiceArm: $(azureServiceConnection)
        backendAzureRmResourceGroupName: 'rg-terraform-state'
        backendAzureRmStorageAccountName: 'sttfstate-$(Build.BuildId)'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'terraform.tfstate'

    # Terraform Validate
    - task: TerraformCLI@1
      displayName: 'Terraform Validate'
      inputs:
        command: 'validate'
        workingDirectory: $(terraformWorkingDirectory)

    # Terraform Format Check
    - task: TerraformCLI@1
      displayName: 'Terraform Format Check'
      inputs:
        command: 'fmt'
        commandOptions: '-check=true -diff=true -recursive'
        workingDirectory: $(terraformWorkingDirectory)

    # Terraform Plan
    - task: TerraformCLI@1
      displayName: 'Terraform Plan'
      inputs:
        command: 'plan'
        workingDirectory: $(terraformWorkingDirectory)
        backendType: azurerm
        backendServiceArm: $(azureServiceConnection)
        backendAzureRmResourceGroupName: 'rg-terraform-state'
        backendAzureRmStorageAccountName: 'sttfstate-$(Build.BuildId)'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'terraform.tfstate'
        commandOptions: '-out=tfplan -var="environment=dev"'

    # Publish Plan Artifact
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Terraform Plan'
      inputs:
        PathtoPublish: '$(terraformWorkingDirectory)/tfplan'
        ArtifactName: 'terraform-plan'
        publishLocation: 'Container'